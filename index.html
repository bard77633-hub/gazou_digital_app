<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>画像のデジタル化体験（比較表示）</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
</head>
<body>
  <h2>画像のデジタル化体験（標本化・量子化）</h2>
  <p>画像をアップロードし、標本化（解像度）と量子化（階調数）を変えて画質の変化を比較してみよう。</p>

  <input type="file" id="imageInput" accept="image/*" /><br /><br />

  標本化（解像度）：
  <input type="range" id="sampleSlider" min="10" max="300" value="150" step="10" />
  <span id="sampleLabel">150 dpi</span><br />

  量子化（階調数）：
  <input type="range" id="quantSlider" min="2" max="256" value="128" step="2" />
  <span id="quantLabel">128階調</span>

  <div id="canvasContainer" style="margin-top: 10px; display: flex; gap: 20px;"></div>

  <script>
    let img;
    let sampleSlider, quantSlider;
    let sampleLabel, quantLabel;
    let baseWidth = 300;
    let leftCanvas, rightCanvas;

    function preload() {
      // 初期サンプル画像（著作権フリー）
      img = loadImage("https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/JPEG_example_flower.jpg/320px-JPEG_example_flower.jpg");
    }

    function setup() {
      leftCanvas = createCanvas(baseWidth * 2 + 20, baseWidth);
      leftCanvas.parent("canvasContainer");
      pixelDensity(1);
      noLoop();

      sampleSlider = document.getElementById("sampleSlider");
      quantSlider = document.getElementById("quantSlider");
      sampleLabel = document.getElementById("sampleLabel");
      quantLabel = document.getElementById("quantLabel");

      sampleSlider.addEventListener("input", updateImage);
      quantSlider.addEventListener("input", updateImage);

      document.getElementById("imageInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          img = loadImage(URL.createObjectURL(file), () => {
            redraw();
          });
        }
      });
    }

    function updateImage() {
      const dpi = sampleSlider.value;
      const quant = quantSlider.value;
      sampleLabel.textContent = `${dpi} dpi`;
      quantLabel.textContent = `${quant}階調`;
      redraw();
    }

    function draw() {
      background(240);
      if (!img) return;

      const dpi = sampleSlider.value;
      const quant = quantSlider.value;

      // ==== 左側：原画像 ====
      let aspect = img.height / img.width;
      image(img, 0, 0, baseWidth, baseWidth * aspect);
      textAlign(CENTER);
      fill(0);
      text("原画像", baseWidth / 2, baseWidth * aspect + 15);

      // ==== 右側：標本化＋量子化後 ====
      const scaleFactor = dpi / 300; // 300dpiを基準にした相対スケール
      const w = int(baseWidth * scaleFactor);
      const h = int(baseWidth * aspect * scaleFactor);

      let processed = createImage(w, h);
      processed.copy(img, 0, 0, img.width, img.height, 0, 0, w, h);
      processed.loadPixels();

      // 量子化処理
      for (let i = 0; i < processed.pixels.length; i += 4) {
        processed.pixels[i] = quantize(processed.pixels[i], quant);
        processed.pixels[i + 1] = quantize(processed.pixels[i + 1], quant);
        processed.pixels[i + 2] = quantize(processed.pixels[i + 2], quant);
      }
      processed.updatePixels();

      // 標本化による拡大再表示（モザイク効果）
      noSmooth();
      image(processed, baseWidth + 20, 0, baseWidth, baseWidth * aspect);
      textAlign(CENTER);
      fill(0);
      text(`標本化: ${dpi}dpi / 量子化: ${quant}階調`, baseWidth * 1.5 + 10, baseWidth * aspect + 15);
    }

    function quantize(value, levels) {
      const step = 255 / (levels - 1);
      return Math.round(value / step) * step;
    }
  </script>
</body>
</html>
